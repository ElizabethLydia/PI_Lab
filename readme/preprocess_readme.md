# PI-Lab 数据预处理脚本 README

## 概述
此脚本旨在预处理Biopac高频数据和HUB低频数据，后续用于PTT（脉搏传输时间）预测血压项目。脚本实现了以下核心功能：
- **Biopac数据处理**：先降采样到100Hz，再插值处理重复时间戳。
- **HUB数据处理**：仅插值处理重复时间戳。
- **数据对齐**：基于参考信号（优先`sensor2`）进行插值对齐。
- **数据保存**：以`.pkl`和`.npy`双格式保存处理结果。

## 安装与依赖
### 依赖库
确保您的Python环境已安装以下库：
- `numpy`
- `pandas`
- `scipy`
- `tqdm`
- `pickle`（Python内置）

### 安装步骤
1. 克隆或下载脚本到本地：
   ```bash
   git clone <https://github.com/ElizabethLydia/PI_Lab>  # 如果有版本控制
   cd <script-directory>
   ```
2. 创建虚拟环境（可选但推荐）：
   ```bash
   python3 -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```
3. 安装依赖：
   ```bash
   pip install numpy pandas scipy tqdm
   ```

## 使用方法
### 前提条件
- 数据目录结构：`/root/PI_Lab/00017`下包含数字命名的实验文件夹（如`1`, `2`），每个文件夹下有`Biopac`和`HUB`子目录，包含`.csv`文件。
- 每个`.csv`文件需包含`timestamp`列作为时间戳。

### 运行脚本
1. 修改脚本中的`pi_lab_folder`变量（如需更改数据路径）：
   ```python
   pi_lab_folder = '/your/data/path'
   ```
2. 执行脚本：
   ```bash
   python script_name.py
   ```
3. 脚本会自动扫描数据目录，处理所有实验，并输出日志和结果文件。

### 参数说明
- `TARGET_FREQ = 100`：目标采样频率（Hz），当前设置为100Hz。
- `MAX_EXPERIMENTS = None`：限制处理实验数量，设为整数（如5）可限制处理前5个实验，`None`表示处理全部。

## 输出说明
### 日志输出
脚本会在终端显示详细处理过程，包括：
- 每个实验的加载和对齐进度。
- Biopac和HUB文件的处理详情（行数、频率估算、降采样步长等）。
- 最终统计（处理时间、文件数量等）。

### 文件输出
- **存储路径**：`/root/PI_Lab/output/`
- **文件格式**：
  - `.pkl`：序列化保存对齐后的数据字典，文件名如`experiment_1_aligned.pkl`。
  - `.npy`：以NumPy格式保存对齐数据，文件名如`experiment_1_aligned.npy`。
- **文件内容**：每个文件包含一个字典，键为实验名，值为包含`biopac`和`hub`数据的嵌套字典。
- **文件大小**：以MB为单位显示，取决于数据量。

### 示例输出
```
🚀 PI-Lab智能数据预处理
============================================================
数据路径: /root/PI_Lab/00017
目标频率: 100Hz
策略: Biopac降采样 + HUB插值 + 插值对齐 + 双格式保存
============================================================
发现实验: ['1', '2', '3']
总共处理: 3 个实验

[1/3] 开始处理实验 1
==================================================
处理实验 1
==================================================
Biopac文件 (9 个) - 降采样+插值策略:
    Biopac mean_bp-11.csv (240,059 行)
      估算频率: 2000.0Hz -> 目标: 100Hz
      降采样: 240,059 -> 12,003 行 (步长: 20)
      插值处理重复时间戳...
      最终: 12,003 行 (压缩比: 20.0:1)
  ...
HUB文件 (4 个) - 使用插值策略:
    HUB sensor2.csv (66,669 行)
      插值处理重复时间戳...
      修复了 10,456 个重复时间戳
      最终: 56,213 行
  ...

插值对齐阶段
==================================================
对齐实验 1...
  使用 sensor2 作为参考 (56,213 行)
  ...
  保存PKL: /root/PI_Lab/output/experiment_1_aligned.pkl
  保存NPY (单文件): /root/PI_Lab/output/experiment_1_aligned.npy, 大小: 2.50 MB
```

## 注意事项
1. **数据路径**：确保`/root/PI_Lab/00017`存在且有读写权限，若路径不同，请修改`pi_lab_folder`。
2. **时间戳格式**：脚本假设`timestamp`为浮点数，若格式不符（例如字符串），需预处理CSV文件。
3. **性能优化**：对于数百万行数据，建议分批处理或增加内存资源。
4. **错误处理**：若出现`插值错误`或`警告: 无有效参考数据`，请检查数据完整性或联系开发者。
5. **版本更新**：脚本可能根据需求调整，建议定期检查更新。
- **时间**：2025年7月10日